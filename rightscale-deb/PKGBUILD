# Maintainer: Chris Fordham <chris.fordham@rightscale.com>

pkgname=rightscale-deb
pkgver=5.8.12
pkgrel=2
epoch=
pkgdesc="RightScale RightLink cloud instance agent."
arch=('x86_64')
url="http://rightscale.com/"
license=('RightScale')
groups=()
depends=(bash dnsutils lsb-release sudo openssh curl)
makedepends=(binutils util-linux patch)
checkdepends=()
optdepends=()
provides=()
conflicts=(rightscale)
replaces=()
backup=()
options=()
install=rightscale.install
changelog=
source=(
  http://mirror.rightscale.com/rightscale_rightlink/5.8.12/ubuntu/rightscale_5.8.12-ubuntu_12.04-amd64.deb
  post_install.sh.patch
  rightscale_functions.patch
  system_configurator.rb.patch
  rightscale.service
  rightlink.service
)
noextract=()
md5sums=('872fd32ec762a1c4cb45b49321341c18'
         '33c019f13ef06608ea727e9481145b68'
         '7b30cc847f0371f46f6d036a267b1238'
         '50744b86d5d0f8c644bc297ccf6ab8bd'
         '828711ba0afc77968af0ef27389f1308'
         '57722584c03bce54d3f61d283d4250e4')      # generate with 'makepkg -g'

prepare() {
  cd "$srcdir"
  
  msg "Extracting RightScale RightLink debian binary package..."
  ar x "$srcdir/rightscale_5.8.12-ubuntu_12.04-amd64.deb"
  
  msg "Extracting data.tar.gz..."
  tar zxf "$srcdir/data.tar.gz"
  
  #msg "Extracting control.tar.gz..."
  #tar zxf "$srcdir/control.tar.gz"
  
  msg "Applying patches for Arch Linux compat..."
  patch -p0 < "$startdir/post_install.sh.patch"
  patch -p0 < "$startdir/rightscale_functions.patch"
  patch -p0 < "$startdir/system_configurator.rb.patch"

  msg "Adding systemd service configurations..."
  mkdir -p "$srcdir/etc/systemd/system"
  cp "$startdir/rightscale.service" "$srcdir/etc/systemd/system/rightscale.service"
  cp "$startdir/rightlink.service" "$srcdir/etc/systemd/system/rightlink.service"  
}

build() {
  msg "Adding empty directory, /etc/rightscale.d to source."
  mkdir -p "$srcdir/etc/rightscale.d"
  msg "Adding empty directory, /var/spool/cloud to source."
  mkdir -p "$srcdir/var/spool/cloud"
}

check() {
  [ -e "$srcdir/etc" ]
  [ -e "$srcdir/opt/rightscale" ]
  [ -e "$srcdir/var" ]
}

package() {
  msg 'Moving /etc into package.'
  mv "$srcdir/etc" "$pkgdir/"
  msg 'Moving /opt into package.'
  mv "$srcdir/opt" "$pkgdir/"
  msg 'Moving /var into package.'
  mv "$srcdir/var" "$pkgdir/"
}

# vim:set ts=2 sw=2 et: